ARG svc_name=emojivoto-emoji-svc

# Build stage
FROM --platform=$BUILDPLATFORM golang:1.25-alpine AS builder
WORKDIR /build

# Install build tools
RUN apk add --no-cache protobuf-dev protoc build-base git make
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.31.0
RUN go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3.0

# Copy dependencies first for better caching
COPY go.mod go.sum ./
RUN go mod download

# Copy source and build
COPY . .
ARG TARGETARCH
ARG svc_name
RUN GOARCH=$TARGETARCH make -C $svc_name clean protoc compile

# Webpack stage for web service
FROM --platform=$BUILDPLATFORM node:20-alpine AS webpack
WORKDIR /build
RUN apk add --no-cache make
COPY . .
RUN make -C emojivoto-web clean webpack package-web

# Combine builds
FROM builder AS build-web
COPY --from=webpack /build/emojivoto-web/target/ /build/emojivoto-web/target/

FROM builder AS build-emoji
FROM builder AS build-voting

# Runtime stage
FROM debian:bullseye-slim
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl dnsutils iptables jq nghttp2 && rm -rf /var/lib/apt/lists/*

ARG svc_name
COPY --from=build-$svc_name /build/$svc_name/target/ /usr/local/bin/

ENV SVC_NAME=$svc_name
WORKDIR /usr/local/bin
ENTRYPOINT ["/bin/sh", "-c", "exec \"$SVC_NAME\" \"$@\""]